trials: 3
model_selection_trials: 1
results_dir: /anfs/bigdisc/me466/mixcem_results/traffic_four_lanes_incomp/

model_selection_groups:
  - ["^(CBM_Sigmoid_).*$", "Joint CBM"]
  - ["^(Hybrid-CBM_).*$", "Hybrid-CBM"]
  - ["^(CEM_).*$", "CEM"]
  - ["^(IntCEM_).*$", "IntCEM"]
  - ["^(MixCEM_).*$", "MixCEM"]
  - ["^(ProbCBM_).*$", "ProbCBM"]
  - ["^(PCBM_).*$", "Posthoc CBM"]
  - ["^(HybridPCBM_).*$", "Posthoc Hybrid CBM"]
  - ["^(ConceptMixIntCEM_0).*(_ce_30_).*$", "ConceptMixIntCEM No Pretaining"]
  - ["^(ConceptMixIntCEM_5).*(_ce_30_).*$", "ConceptMixIntCEM Pretrained"]
  - ["^(ConceptMixCEM_0).*(_ce_30_).*$", "ConceptMixCEM No Pretaining"]
  - ["^(ConceptMixCEM_5).*(_ce_30_).*$", "ConceptMixCEM Pretrained"]


model_selection_metrics:
  - val_auc_y_random_group_level_True_use_prior_False_int_auc
  - val_auc_y

shared_params:
  # Dataset Configuration
  dataset_config:
    dataset: "traffic"
    num_workers: 8
    batch_size: 64

    # DATASET VARIABLES
    root_dir: /home/me466/traffic_dataset/complete_dataset_four_lanes_diff_distr/
    selected_concepts: [0, 1, 4, 5, 6, 7, 8]
    sampling_percent: 1
    test_subsampling: 1
    weight_loss: False #True
    dataset_size: 0.25

  # Intervention Parameters
  intervention_config:
    competence_levels: [1]
    intervention_freq: 1
    intervention_batch_size: 256
    use_auc: True
    val_intervention_policies:
      - policy: "random"
        group_level: True
        use_prior: False
    intervention_policies:
      - policy: "random"
        group_level: True
        use_prior: False

  # Representation metrics
  # Change to False if you want representation metrics to be included in the
  # evaluation (may significantly increase experiment times)
  skip_repr_evaluation: True

  max_epochs: 100
  top_k_accuracy: null
  save_model: True
  patience: 3
  concept_loss_weight: [5, 1, 10]
  c_extractor_arch: cnn
  c_extractor_config:
    activation_fn: leakyrelu
    cnn_layers:
      - out_channels: 4
        filter: [3, 3]
      - out_channels: 4
        filter: [3, 3]
        batchnorm: True
      - out_channels: 4
        filter: [3, 3]
      - out_channels: 4
        filter: [3, 3]
        batchnorm: True
        # max_pool_kernel: [3, 3]
      # - out_channels: 8
      #   filter: [3, 3]
      # - out_channels: 8
      #   filter: [3, 3]
      # - out_channels: 8
      #   filter: [3, 3]
      # - out_channels: 8
      #   filter: [3, 3]
      #   max_pool_kernel: [5, 5]
      # - out_channels: 16
      #   filter: [3, 3]
      # - out_channels: 16
      #   filter: [3, 3]
      # - out_channels: 16
      #   filter: [3, 3]
      # - out_channels: 16
      #   filter: [3, 3]
      #   # max_pool_kernel: [3, 3]
      - out_channels: 32
        filter: [3, 3]
      - out_channels: 32
        filter: [3, 3]
        batchnorm: True
        max_pool_kernel: [5, 5]
    mlp_layers: [32, 16]

  learning_rate: 0.01
  weight_loss: False #True
  optimizer: sgd
  early_stopping_monitor: val_loss
  early_stopping_mode: min
  early_stopping_delta: 0.0
  momentum: 0.9

  grid_variables:
    - concept_loss_weight
  grid_search_mode: exhaustive

  # Evaluation configuration
  eval_config:
    additional_test_sets:
      - name: "OOD"
        update_previous: True
        dataset_config:
          test_transformation_config:
            name: random_noise
            low_noise_level: 1
            noise_level: 0.5

runs:
  - architecture: 'ConceptBottleneckModel'
    run_name: "CBM_Sigmoid_cwl_{concept_loss_weight}"
    training_intervention_prob: 0
    embedding_activation: "leakyrelu"
    bool: False
    extra_dims: 0
    sigmoidal_extra_capacity: False
    sigmoidal_prob: True

  - architecture: 'ConceptBottleneckModel'
    run_name: "DNN_extra_dims_{extra_dims}"
    extra_dims: [50]
    training_intervention_prob: 0
    embedding_activation: "leakyrelu"
    sigmoidal_prob: False
    concept_loss_weight: 0
    bool: False
    grid_variables:
      - extra_dims
    grid_search_mode: exhaustive

  - architecture: 'ConceptBottleneckModel'
    run_name: "CBM_Logit_cwl_{concept_loss_weight}"
    embedding_activation: "leakyrelu"
    bool: False
    extra_dims: 0
    sigmoidal_extra_capacity: False
    sigmoidal_prob: False
    gradient_clip_val: 100

  - architecture: 'ConceptEmbeddingModel'
    run_name: "CEM_emb_size_{emb_size}_cwl_{concept_loss_weight}"
    sigmoidal_prob: True
    training_intervention_prob: 0.25
    emb_size: 16
    embedding_activation: "leakyrelu"

  - architecture: "IntAwareConceptEmbeddingModel"
    run_name: "IntCEM_emb_size_{emb_size}_intervention_weight_{intervention_weight}_intervention_task_discount_{intervention_task_discount}_cwl_{concept_loss_weight}"
    training_intervention_prob: 0.25
    intervention_weight: [0.1, 1]
    intervention_task_discount: [1.1, 1.5]
    use_concept_groups: True
    int_model_use_bn: True
    int_model_layers: [128, 128, 64, 64]
    embedding_activation: "leakyrelu"
    max_horizon: 6
    horizon_rate: 1.005
    gradient_clip_val: 100
    emb_size: [16]
    grid_variables:
        - concept_loss_weight
        - intervention_task_discount
        - intervention_weight
        - emb_size
    grid_search_mode: exhaustive

  - architecture: 'ProbabilisticConceptBottleneckModel'
    run_name: "ProbCBM_cwl_class_hidden_dim_{class_hidden_dim}_hidden_dim_{hidden_dim}_n_samples_inference_{n_samples_inference}_max_concept_epochs_{max_concept_epochs}_max_task_epochs_{max_task_epochs}"
    n_samples_inference: 50
    use_neg_concept: True
    pred_class: True
    init_negative_scale: 5
    init_shift: 5
    pretrained: True
    hidden_dim: [16, 32]
    class_hidden_dim: [64, 128]
    intervention_prob: 0.5
    # gradient_clip_val: 2.0
    max_concept_epochs: 50
    warmup_epochs: 5
    max_task_epochs: 50
    vib_beta: 0.00005
    concept_loss_weight: 1
    lr_ratio: 10
    grid_variables:
      - class_hidden_dim
      - hidden_dim
    grid_search_mode: exhaustive
